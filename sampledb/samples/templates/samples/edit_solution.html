{% extends "samples/base.html" %}

{% block title %}Edit Solution{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Edit Solution</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        
        <!-- Sample Info Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Analysis Task</h3>
          </div>
          <div class="card-body">
            <dl class="row mb-0">
              <dt class="col-sm-3">SHA256</dt>
              <dd class="col-sm-9">
                <code class="text-danger">{{ sample.sha256 }}</code>
              </dd>

              {% if sample.goal %}
              <dt class="col-sm-3">Goal</dt>
              <dd class="col-sm-9">
                {{ sample.goal|truncatewords:30 }}
              </dd>
              {% endif %}
            </dl>
          </div>
        </div>

        <!-- Solution Form Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Solution Details</h3>
          </div>
          <div class="card-body">
            <form method="post" novalidate>
              {% csrf_token %}
              
              <div class="form-group">
                <label for="{{ form.title.id_for_label }}">Title</label>
                {{ form.title }}
                {% if form.title.errors %}
                  <div class="text-danger small">
                    {{ form.title.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.solution_type.id_for_label }}">Solution Type</label>
                {{ form.solution_type }}
                {% if form.solution_type.errors %}
                  <div class="text-danger small">
                    {{ form.solution_type.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group" id="url-field">
                <label for="{{ form.url.id_for_label }}">URL</label>
                {{ form.url }}
                {% if form.url.errors %}
                  <div class="text-danger small">
                    {{ form.url.errors }}
                  </div>
                {% else %}
                <small class="form-text text-muted">For external solutions (Blog, Paper, Video)</small>
                {% endif %}
              </div>

              <div class="form-group" id="content-field" style="display: none;">
                <label for="{{ form.content.id_for_label }}">Content</label>
                <div class="alert alert-info mb-2">
                  <i class="fas fa-external-link-alt"></i>
                  <a href="{% url 'markdown_editor' %}" target="_blank" class="alert-link">Open Full Markdown Editor</a> in a new tab for a better writing experience. Copy your content back here when done.
                </div>
                <div class="markdown-tabs">
                  <button type="button" class="markdown-tab active" data-tab="write">
                    <i class="fas fa-edit"></i> Write
                  </button>
                  <button type="button" class="markdown-tab" data-tab="preview">
                    <i class="fas fa-eye"></i> Preview
                  </button>
                </div>
                <div class="markdown-tab-content">
                  <div class="markdown-pane active" data-pane="write">
                    {{ form.content }}
                  </div>
                  <div class="markdown-pane" data-pane="preview">
                    <div class="markdown-preview-content">
                      <p class="text-muted">Nothing to preview</p>
                    </div>
                  </div>
                </div>
                {% if form.content.errors %}
                  <div class="text-danger small">
                    {{ form.content.errors }}
                  </div>
                {% else %}
                <small class="form-text text-muted">Markdown content for on-site solutions. Images via external links are supported.</small>
                {% endif %}
              </div>

              {% if form.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form.non_field_errors }}
                </div>
              {% endif %}

              <div class="form-group mb-0">
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-save"></i> Update Solution
                </button>
                <a href="{% url 'sample_detail' sha256=sample.sha256 task_id=sample.id %}" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
            </form>
          </div>
        </div>

      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Guidelines</h3>
          </div>
          <div class="card-body">
            <p class="small mb-2">Provide a descriptive title for your solution</p>
            <p class="small mb-2">Select the appropriate type (Blog, Paper, Video, or On-Site Article)</p>
            <p class="small mb-2">External solutions require a publicly accessible link</p>
            <p class="small mb-0">On-site solutions allow you to write content directly using markdown</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const solutionTypeSelect = document.getElementById('id_solution_type');
  const urlField = document.getElementById('url-field');
  const contentField = document.getElementById('content-field');
  const tabs = document.querySelectorAll('.markdown-tab');
  const panes = document.querySelectorAll('.markdown-pane');
  const textarea = document.getElementById('id_content');
  const previewContent = document.querySelector('.markdown-preview-content');
  let previewCache = '';
  
  // Toggle fields based on solution type
  function toggleFields() {
    const selectedType = solutionTypeSelect.value;
    if (selectedType === 'onsite') {
      urlField.style.display = 'none';
      contentField.style.display = 'block';
    } else {
      urlField.style.display = 'block';
      contentField.style.display = 'none';
    }
  }
  
  // Initial toggle
  toggleFields();
  
  // Listen for changes
  solutionTypeSelect.addEventListener('change', toggleFields);
  
  // Markdown preview tabs
  tabs.forEach(tab => {
    tab.addEventListener('click', function() {
      const targetTab = this.getAttribute('data-tab');
      
      // Update active tab
      tabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      // Update active pane
      panes.forEach(p => {
        if (p.getAttribute('data-pane') === targetTab) {
          p.classList.add('active');
        } else {
          p.classList.remove('active');
        }
      });
      
      // If switching to preview, render markdown
      if (targetTab === 'preview') {
        const content = textarea.value;
        
        // Only fetch if content changed
        if (content !== previewCache) {
          previewCache = content;
          
          if (!content.trim()) {
            previewContent.innerHTML = '<p class="text-muted">Nothing to preview</p>';
            return;
          }
          
          // Show loading state
          previewContent.innerHTML = '<p class="text-muted"><i class="fas fa-spinner fa-spin"></i> Loading preview...</p>';
          
          // Fetch preview from server
          fetch('{% url "markdown_preview" %}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: 'content=' + encodeURIComponent(content)
          })
          .then(response => response.json())
          .then(data => {
            previewContent.innerHTML = data.html;
          })
          .catch(error => {
            console.error('Preview error:', error);
            previewContent.innerHTML = '<p class="text-danger"><i class="fas fa-exclamation-triangle"></i> Error loading preview</p>';
          });
        }
      }
    });
  });
});
</script>

{% endblock %}
