{% extends "samples/base.html" %}
{% load cloudinary %}

{% block title %}Trainings Samples{% endblock %}

{% block extra_css %}
<style>
.clickable-row:hover {
  background-color: rgba(0, 255, 65, 0.15) !important;
}
</style>
{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Trainings Samples</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Database Query</h3>

        <div class="card-tools">
          <form method="get" class="form-inline">
            <div class="input-group input-group-sm mr-2" style="width: 520px;">
              <input
                type="text"
                name="q"
                class="form-control"
                placeholder="> SEARCH SHA256..."
                value="{{ q }}"
              >
            </div>
            
            <select name="difficulty" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">[ALL LEVELS]</option>
              {% for value, label in difficulties %}
                <option value="{{ value }}" {% if selected_difficulty == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            
            <select name="tag" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Tags</option>
              {% for tag in all_tags %}
                <option value="{{ tag.name }}" {% if selected_tag == tag.name %}selected{% endif %}>
                  {{ tag.name }}
                </option>
              {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-default btn-sm">
              [EXECUTE]
            </button>
            {% if q or selected_tag or selected_difficulty %}
              <a href="/" class="btn btn-sm btn-secondary ml-1">[RESET]</a>
            {% endif %}
          </form>
        </div>
      </div>

      <div class="card-body p-0">
        <table class="table table-striped table-hover text-nowrap table-sm">
          <thead>
            <tr>
              <th>SHA256</th>
              <th>Difficulty</th>
              <th>Tags</th>
              <th>Goal</th>
              <th style="width: 80px; text-align: center;">Likes</th>
            </tr>
          </thead>
          <tbody>
            {% for s in page_obj %}
            <tr class="clickable-row" data-url="{% url 'sample_detail' s.sha256 %}" style="cursor: pointer;">
              <td style="max-width: 200px; padding: 0.3rem 0.75rem;">
                <a href="{% url 'sample_detail' s.sha256 %}" class="d-flex align-items-center" style="min-width: 0;">
                  {% if s.image %}
                    <img src="{% cloudinary_url s.image width=32 height=32 crop='fill' %}" alt="Thumbnail" class="rounded mr-2" style="width: 32px; height: 32px; object-fit: cover; flex-shrink: 0;">
                  {% else %}
                    <div class="rounded mr-2 bg-secondary" style="width: 32px; height: 32px; display: inline-block; flex-shrink: 0;"></div>
                  {% endif %}
                  <code style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0;" title="{{ s.sha256 }}">{{ s.sha256 }}</code>
                </a>
              </td>

<td>
  <a href="/?difficulty={{ s.difficulty }}"
     class="badge
     {% if s.difficulty == 'easy' %}badge-success
     {% elif s.difficulty == 'medium' %}badge-warning
     {% elif s.difficulty == 'advanced' %}badge-danger
     {% else %}badge-dark{% endif %}">
    [{{ s.difficulty|upper }}]
  </a>
</td>


              <td>
                {% for tag in s.tags.all %}
                  <a href="/?tag={{ tag.name|urlencode }}" class="badge badge-tag">
  #{{ tag.name|upper }}
</a>

                {% empty %}
                  <span class="text-muted">[NONE]</span>
                {% endfor %}
              </td>

              <td style="color: #88ff88;">
                {{ s.goal|truncatechars:80 }}
              </td>

              <td style="text-align: center;">
                {% if s.like_count > 0 %}
                  <span style="color: #ff0066;" title="{{ s.like_count }} like{{ s.like_count|pluralize }}">
                    â™¥ {{ s.like_count }}
                  </span>
                {% else %}
                  <span class="text-muted">[0]</span>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center">
                [NO RECORDS FOUND IN DATABASE]
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-footer clearfix">
        <span class="float-left">
          [PAGE {{ page_obj.number }}/{{ page_obj.paginator.num_pages }}]
        </span>

        <ul class="pagination pagination-sm m-0 float-right">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.previous_page_number }}&q={{ q }}">
              << PREV
            </a>
          </li>
          {% endif %}
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.next_page_number }}&q={{ q }}">
              NEXT >>
            </a>
          </li>
          {% endif %}
        </ul>
      </div>

    </div>

  </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
// Make table rows clickable except for links
document.querySelectorAll('.clickable-row').forEach(row => {
  row.addEventListener('click', function(e) {
    // Don't navigate if clicking on a link or badge (tags/difficulty)
    if (e.target.closest('a') || e.target.closest('.badge')) {
      return;
    }
    window.location.href = this.dataset.url;
  });
});
</script>
{% endblock %}
