{% extends "samples/base.html" %}

{% load url_helpers %}  
{% load cloudinary %}
{% load user_tags %}
{% block title %}Trainings Samples{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Trainings Samples</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Samples</h3>

        <div class="card-tools">
          <form method="get" class="form-inline">
            <div class="input-group input-group-sm mr-2" style="width: 520px;">
              <input
                type="text"
                name="q"
                class="form-control"
                placeholder="Search SHA256"
                value="{{ q }}"
              >
            </div>
            
            <select name="difficulty" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Levels</option>
              {% for value, label in difficulties %}
                <option value="{{ value }}" {% if selected_difficulty == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            
            <select name="tag" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Tags</option>
              {% for tag in all_tags %}
                <option value="{{ tag.name }}" {% if selected_tag == tag.name %}selected{% endif %}>
                  {{ tag.name }}
                </option>
              {% endfor %}
            </select>
            
            {% if user.is_authenticated %}
              <input type="hidden" name="favorites" value="{{ favorites_only|yesno:'true,false' }}">
              <button type="button" class="btn btn-sm mr-2 {% if favorites_only %}btn-danger{% else %}btn-default{% endif %}" onclick="toggleFavorites(this.form)">
                <i class="fas fa-heart"></i> My Likes
              </button>
            {% endif %}
            
            <button type="submit" class="btn btn-default btn-sm mr-2">
              Filter
            </button>
            {% if q or selected_tag or selected_difficulty or favorites_only %}
              <a href="/" class="btn btn-sm btn-secondary mr-2">Clear</a>
            {% endif %}
            {% if perms.samples.add_analysistask %}
              <a href="{% url 'submit_task' %}" class="btn btn-danger btn-sm mr-2">
                <i class="fas fa-plus"></i> Submit
              </a>
            {% endif %}
          </form>
        </div>
      </div>

<script>
function toggleFavorites(form) {
  const favInput = form.querySelector('input[name="favorites"]');
  if (favInput.value === 'true') {
    favInput.value = 'false';
  } else {
    favInput.value = 'true';
  }
  form.submit();
}
</script>      <div class="card-body p-0">
        <table class="table table-striped table-hover text-nowrap table-sm">
          <thead>
            <tr>
             <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='sha256' minus_field='-sha256' label='SHA256' %}
            </th>
              <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='difficulty' minus_field='-difficulty' label='Difficulty' %}
              </th>
              <th><span class="text-dark">Tags</span></th>
              <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='goal' minus_field='-goal' label='Goal' %}
              </th>
              <th style="width: 80px; text-align: center; cursor: pointer;">
                <span class="text-dark">Solutions</span>
              </th>
              <th style="width: 80px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='likes' minus_field='-likes' label='Likes' %}
              </th>
              <th style="width: 100px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='created' minus_field='-created' label='Created' %}
              </th>
            </tr>
          </thead>
          <tbody>
            {% for s in page_obj %}
            <tr>
              <td style="max-width: 200px; padding: 0.3rem 0.75rem;">
                <a href="{% url 'sample_detail' s.sha256 s.id %}" class="d-flex align-items-center" style="min-width: 0;">
                  {% if s.image %}
                    <img src="{% cloudinary_url s.image width=32 height=32 crop='fill' %}" alt="Thumbnail" class="rounded mr-2" style="width: 32px; height: 32px; object-fit: cover; flex-shrink: 0;">
                  {% else %}
                    <div class="rounded mr-2 bg-secondary" style="width: 32px; height: 32px; display: inline-block; flex-shrink: 0;"></div>
                  {% endif %}
                  <code style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0;" title="{{ s.sha256 }}">{{ s.sha256 }}</code>
                </a>
              </td>
              <td>
                {% difficulty_badge s.difficulty s.difficulty %}
              </td>
              <td>
                {% for tag in s.tags.all %}
                  <a href="/?tag={{ tag.name|urlencode }}" class="badge badge-tag">
                    {{ tag.name }}
                  </a>

                {% empty %}
                  <span class="text-muted">—</span>
                {% endfor %}
              </td>

              <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <a href="{% url 'sample_detail' s.sha256 s.id %}" class="text-muted">
                  {{ s.goal|truncatechars:80 }}
                </a>
              </td>

              <td style="text-align: center;">
                {% if s.solutions.count > 0 %}
                  <span class="text-success" title="{{ s.solutions.count }} solution{{ s.solutions.count|pluralize }}">
                    <i class="fas fa-check-circle"></i> {{ s.solutions.count }}
                  </span>
                {% endif %}
                {% if s.youtube_id %}
                  <a href="https://www.youtube.com/watch?v={{ s.youtube_id }}" target="_blank" title="Watch video tutorial" class="ml-1">
                    <i class="fab fa-youtube text-danger"></i>
                  </a>
                {% endif %}
                {% if not s.solutions.count and not s.youtube_id %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>

              <td style="text-align: center;">
                <button class="btn btn-link p-0 favorite-btn" 
                        data-sha256="{{ s.sha256 }}"
                        data-task-id="{{ s.id }}"
                        data-liked="{% if s.id in user_favorited_ids %}true{% else %}false{% endif %}"
                        style="border: none; background: none; cursor: pointer;">
                  {% if s.id in user_favorited_ids %}
                    <span class="text-danger" title="{{ s.favorite_count }} favorite{{ s.favorite_count|pluralize }}">
                      <i class="fas fa-heart"></i> <span class="favorite-count">{{ s.favorite_count }}</span>
                    </span>
                  {% else %}
                    <span class="text-muted" title="{{ s.favorite_count }} favorite{{ s.favorite_count|pluralize }}">
                      <i class="far fa-heart"></i> <span class="favorite-count">{{ s.favorite_count }}</span>
                    </span>
                  {% endif %}
                </button>
              </td>
              <td style="text-align: center;">
                <span class="text-muted" style="font-size: 0.9em;">{{ s.created_at|date:"d M Y" }}</span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">
                No samples found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-footer clearfix">
        <span class="float-left text-muted">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        <ul class="pagination pagination-sm m-0 float-right">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="{% url_replace page=page_obj.previous_page_number %}">
              «
            </a>
          </li>
          {% endif %}
          
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="{% url_replace page=page_obj.next_page_number %}">
              »
            </a>
          </li>
          {% endif %}
        </ul>
      </div>

    </div>

  </div>
</section>

{% endblock %}
