{% extends "samples/base.html" %}

{% load url_helpers %}  
{% load cloudinary %}
{% load user_tags %}
{% load comments %}
{% block title %}Trainings Samples{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Trainings Samples</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Samples</h3>

        <div class="card-tools">
          <form method="get" class="form-inline">
            <div class="input-group input-group-sm mr-2" style="width: 520px;">
              <input
                type="text"
                name="q"
                class="form-control"
                placeholder="Search SHA256"
                value="{{ q }}"
              >
            </div>
            
            <select name="difficulty" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Levels</option>
              {% for value, label in difficulties %}
                <option value="{{ value }}" {% if selected_difficulty == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            
            <select name="tag" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Tags</option>
              {% for tag in all_tags %}
                <option value="{{ tag.name }}" {% if selected_tag == tag.name %}selected{% endif %}>
                  {{ tag.name }}
                </option>
              {% endfor %}
            </select>
            
            {% if user.is_authenticated %}
              <input type="hidden" name="favorites" value="{{ favorites_only|yesno:'true,false' }}">
              <button type="button" class="btn btn-sm mr-2 {% if favorites_only %}btn-danger{% else %}btn-default{% endif %}" onclick="toggleFavorites(this.form)">
                <i class="fas fa-heart"></i> My Likes
              </button>
            {% endif %}
            
            <button type="submit" class="btn btn-default btn-sm mr-2">
              Filter
            </button>
            {% if q or selected_tag or selected_difficulty or favorites_only %}
              <a href="/?browse=true" class="btn btn-sm btn-secondary mr-2">Clear</a>
            {% endif %}
            {% if user.is_authenticated %}
              <a href="{% url 'submit_task' %}" class="btn btn-danger btn-sm mr-2" id="submitTaskBtn">
                <i class="fas fa-plus"></i> Submit
              </a>
            {% endif %}
          </form>
        </div>
      </div>

<script>
function toggleFavorites(form) {
  const favInput = form.querySelector('input[name="favorites"]');
  if (favInput.value === 'true') {
    favInput.value = 'false';
  } else {
    favInput.value = 'true';
  }
  form.submit();
}

// Clear localStorage when clicking the Submit button to create a new task
document.addEventListener('DOMContentLoaded', function() {
  const submitTaskBtn = document.getElementById('submitTaskBtn');
  if (submitTaskBtn) {
    submitTaskBtn.addEventListener('click', function() {
      clearFormDrafts();
    });
  }
});
</script>      <div class="card-body p-0">
        <table class="table table-striped table-hover text-nowrap table-sm">
          <thead>
            <tr>
             <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='sha256' minus_field='-sha256' label='SHA256' %}
            </th>
              <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='difficulty' minus_field='-difficulty' label='Difficulty' %}
              </th>
              <th><span class="text-dark">Tags</span></th>
              <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='goal' minus_field='-goal' label='Goal' %}
              </th>
              <th style="width: 80px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='solutions' minus_field='-solutions' label='Solutions' %}
              </th>
              <th style="width: 80px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='likes' minus_field='-likes' label='Likes' %}
              </th>
              <th style="width: 80px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='comments' minus_field='-comments' label='Comments' %}
              </th>
              <th style="width: 100px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='created' minus_field='-created' label='Created' %}
              </th>
            </tr>
          </thead>
          <tbody>
            {% for s in page_obj %}
            <tr>
              
              <!-- SHA256 and Link -->
              <td style="max-width: 200px; padding: 0.3rem 0.75rem;">
                <a href="{% url 'sample_detail' s.sha256 s.id %}" class="d-flex align-items-center" style="min-width: 0;">
                  <i class="fas fa-file-code mr-1" style="flex-shrink: 0; font-size: 1.2rem;"></i>
                  <code style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0;" title="{{ s.sha256 }}">{{ s.sha256 }}</code>
                </a>
              </td>

              <!-- Difficulty Badge -->
              <td>
                {% difficulty_badge s.difficulty s.difficulty %}
              </td>
              
              <td>
                {% include 'samples/_expandable_tag_list.html' with tags=s.tags.all max_width='15vw' %}
              </td>

              <!-- Goal -->
              <td style="max-width: 15vw; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <a href="{% url 'sample_detail' s.sha256 s.id %}" class="text-muted">
                  {{ s.goal }}
                </a>
              </td>

              <!-- Solutions -->
               <td style="text-align: center;">
                <a href="{% url 'sample_detail' s.sha256 s.id %}" class="text-dark">
                  {% solution_icons s %}
                </a>
              </td>

              <!-- Favorites -->
              <td style="text-align: center;">
                {% favorite_button s user_favorited_ids %}
              </td>

              <!-- Comments -->
              <td style="text-align: center;">
              {% get_comment_count for s as comment_count %}
              <a href="{% url 'sample_detail' s.sha256 s.id %}" class="text-dark">
                <i class="fas fa-comment"></i> {{ comment_count }}
              </a>
              </td>

              <!-- Created Date -->
              <td style="text-align: center;">
                <a href="{% url 'sample_detail' s.sha256 s.id %}" class="text-muted">
                  {{ s.created_at|date:"d M Y" }}
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">
                No samples found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-footer clearfix">
        <span class="float-left text-muted">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        <ul class="pagination pagination-sm m-0 float-right">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="{% url_replace page=page_obj.previous_page_number %}">
              «
            </a>
          </li>
          {% endif %}
          
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="{% url_replace page=page_obj.next_page_number %}">
              »
            </a>
          </li>
          {% endif %}
        </ul>
      </div>

    </div>

  </div>
</section>

{% endblock %}
