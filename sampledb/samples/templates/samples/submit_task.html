{% extends "samples/base.html" %}
{% load cloudinary %}

{% block title %}{% if is_edit %}Edit{% else %}Submit{% endif %} Sample{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>{% if is_edit %}Edit{% else %}Submit{% endif %} Analysis Task</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Task Details</h3>
          </div>
          <div class="card-body">
            <form method="post" novalidate>
              {% csrf_token %}
              
              <div class="form-group">
                <label for="{{ form.sha256.id_for_label }}">SHA256 Hash</label>
                {{ form.sha256 }}
                {% if form.sha256.errors %}
                  <div class="text-danger small">
                    {{ form.sha256.errors }}
                  </div>
                {% else %}
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.download_link.id_for_label }}">Download Link</label>
                {{ form.download_link }}
                {% if form.download_link.errors %}
                  <div class="text-danger small">
                    {{ form.download_link.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Provide a malshare or malwarebazaar URL!</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.goal.id_for_label }}">Analysis Goal</label>
                {{ form.goal }}
                {% if form.goal.errors %}
                  <div class="text-danger small">
                    {{ form.goal.errors }}
                  </div>
                {% else %}
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.description.id_for_label }}">Description</label>
                {{ form.description }}
                {% if form.description.errors %}
                  <div class="text-danger small">
                    {{ form.description.errors }}
                  </div>
                {% else %}
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.difficulty.id_for_label }}">Difficulty Level</label>
                {{ form.difficulty }}
                {% if form.difficulty.errors %}
                  <div class="text-danger small">
                    {{ form.difficulty.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.tags.id_for_label }}">Tags</label>
                {{ form.tags }}
                {% if form.tags.errors %}
                  <div class="text-danger small">
                    {{ form.tags.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Comma-separated tags (e.g., ransomware, "string deobfuscation")</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.tools.id_for_label }}">Tools</label>
                {{ form.tools }}
                {% if form.tools.errors %}
                  <div class="text-danger small">
                    {{ form.tools.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Comma-separated tools (e.g., ghidra, x64dbg)</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label>Sample Image (Optional)</label>
                <input type="hidden" id="selected_image" name="image_id" value="">
                <div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle="modal" data-target="#imageGalleryModal">
                    <i class="fas fa-images"></i> Select Image
                  </button>
                  <div id="selected_image_preview" class="mt-2" style="display: none;">
                    <img id="preview_img" src="" alt="Selected" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearImageSelection()">
                      <i class="fas fa-times"></i> Remove
                    </button>
                  </div>
                </div>
                <small class="form-text text-muted">Choose an image from gallery</small>
              </div>

              {% if form.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form.non_field_errors }}
                </div>
              {% endif %}

              <div class="form-group mb-0">
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-save"></i> {% if is_edit %}Update{% else %}Submit{% endif %}
                </button>
                <a href="{% if is_edit %}{% url 'sample_detail' sha256=task.sha256 task_id=task.id %}{% else %}{% url 'sample_list' %}{% endif %}" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
              </div>
            </form>
          </div>
        </div>

      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Submission Guidelines</h3>
          </div>
          <div class="card-body">
            <p class="small mb-3">Provide a valid SHA256 hash (64 hex characters) for the contained file, if the download consists of several files, use the hash of the archive</p>
            <p class="small mb-3">The download link must be to malshare or malwarebazaar</p>
            <p class="small mb-3">Choose the appropriate difficulty level, see explanation below</p>
            </ul>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Difficulty Levels</h3>
          </div>
          <div class="card-body">
            <h6 class="text-info">Easy</h6>
            <p class="small mb-3">
              Easy samples are not packed or obfuscated or have trivial obfuscation like base64. They should only use favorable execution environments (no Rust or Go). Samples must not be self-modifying. Samples can be inside of installers (NSIS) or basic wrappers (Batch2Exe) which drop the non-packed payload to disk.
            </p>
            
            <h6 class="text-warning">Medium</h6>
            <p class="small mb-3">
              Medium samples are easy to unpack (if packed) and can have some obfuscation or simple anti-reversing techniques. Deobfuscation should not require to change the control flow. But deobfuscation may require to decrypt strings or data. Execution environment can be somewhat unfavorable for current tooling.
            </p>
            
            <h6 class="text-danger">Advanced</h6>
            <p class="small mb-0">
              Advanced samples may require to write custom tooling for unpacking or deobfuscation. They may employ several anti-reversing mechanisms or self-modifying code. They may use control flow obfuscation. They may use unusual execution environments without good RE tooling or use packers which require more work for unpacking than just setting a few breakpoints.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Gallery Modal -->
  <div class="modal fade" id="imageGalleryModal" tabindex="-1" role="dialog" aria-labelledby="imageGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageGalleryModalLabel">Select Sample Image</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if available_images %}
            <div class="row">
              {% for img in available_images %}
                {% cloudinary_url img.image width=300 height=300 crop='fill' as image_url %}
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                  <div class="card image-select-card" onclick="selectImage('{{ image_url }}', '{{ img.id }}')" style="cursor: pointer;">
                    <img src="{{ image_url }}" class="card-img-top" alt="Sample image" style="height: 200px; object-fit: cover;">
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No images available in the database yet.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <style>
  .image-select-card {
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  .image-select-card:hover {
    border-color: #e63946;
    transform: scale(1.02);
  }
  .image-select-card.selected {
    border-color: #e63946;
    box-shadow: 0 0 10px rgba(230, 57, 70, 0.5);
  }
  </style>

  <script>
  // Pre-select current image in edit mode
  {% if is_edit and current_image_id %}
  document.addEventListener('DOMContentLoaded', function() {
    const currentImageId = '{{ current_image_id }}';
    if (currentImageId) {
      document.getElementById('selected_image').value = currentImageId;
      
      // Find and show preview of current image
      const imageCard = document.querySelector(`[onclick*="'${currentImageId}'"]`);
      if (imageCard) {
        const imgSrc = imageCard.querySelector('img').src;
        document.getElementById('preview_img').src = imgSrc;
        document.getElementById('selected_image_preview').style.display = 'block';
      }
    }
  });
  {% endif %}
  
  function selectImage(imageUrl, taskId) {
    // Set hidden input value
    document.getElementById('selected_image').value = taskId;
    
    // Update preview
    const previewDiv = document.getElementById('selected_image_preview');
    const previewImg = document.getElementById('preview_img');
    previewImg.src = imageUrl;
    previewDiv.style.display = 'block';
    
    // Highlight selected card
    document.querySelectorAll('.image-select-card').forEach(card => {
      card.classList.remove('selected');
    });
    event.currentTarget.classList.add('selected');
    
    // Close modal
    $('#imageGalleryModal').modal('hide');
  }
  
  function clearImageSelection() {
    document.getElementById('selected_image').value = '';
    document.getElementById('selected_image_preview').style.display = 'none';
    document.querySelectorAll('.image-select-card').forEach(card => {
      card.classList.remove('selected');
    });
  }
  </script>
</section>

{% endblock %}
