{% extends "samples/base.html" %}
{% load cloudinary %}

{% block title %}{% if is_edit %}Edit{% else %}Submit{% endif %} Sample{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>{% if is_edit %}Edit{% else %}Submit{% endif %} Sample</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Task Details</h3>
          </div>
          <div class="card-body">
            <form method="post" novalidate>
              {% csrf_token %}
              
              {% if form.errors %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Form Validation Errors</h5>
                <p class="mb-2">Please correct the following errors:</p>
                <ul class="mb-0">
                  {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endif %}
                  {% for field in form %}
                    {% if field.errors %}
                      {% for error in field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </ul>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              {% endif %}
              
              {% if not is_edit and not user.is_staff %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Reference Solution Required:</strong> You must provide one reference solution (your own writeup, video, or analysis) when submitting a task.
              </div>
              {% endif %}
              
              <div class="form-group">
                <label for="{{ form.sha256.id_for_label }}">SHA256 Hash</label>
                {{ form.sha256 }}
                {% if form.sha256.errors %}
                  <div class="text-danger small">
                    {{ form.sha256.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Auto-filled from download link</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.download_link.id_for_label }}">Download Link</label>
                {{ form.download_link }}
                {% if form.download_link.errors %}
                  <div class="text-danger small">
                    {{ form.download_link.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Provide a malshare or malwarebazaar URL!</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.goal.id_for_label }}">Analysis Goal</label>
                {{ form.goal }}
                {% if form.goal.errors %}
                  <div class="text-danger small">
                    {{ form.goal.errors }}
                  </div>
                {% else %}
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.description.id_for_label }}">Description</label>
                <div class="markdown-tabs">
                  <button type="button" class="markdown-tab active" data-tab="write">Write</button>
                  <button type="button" class="markdown-tab" data-tab="preview">Preview</button>
                </div>
                <div class="markdown-tab-content">
                  <div class="markdown-pane active" data-pane="write">
                    {{ form.description }}
                  </div>
                  <div class="markdown-pane" data-pane="preview">
                    <div class="markdown-preview-content">
                      <p class="text-muted">Nothing to preview</p>
                    </div>
                  </div>
                </div>
                {% if form.description.errors %}
                  <div class="text-danger small">
                    {{ form.description.errors }}
                  </div>
                {% else %}
                <small class="form-text text-muted">This field accepts markdown formatting, feel free to add tips here, the field will be in a spoiler</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.difficulty.id_for_label }}">Difficulty Level</label>
                {{ form.difficulty }}
                {% if form.difficulty.errors %}
                  <div class="text-danger small">
                    {{ form.difficulty.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.platform.id_for_label }}">Platform</label>
                {{ form.platform }}
                {% if form.platform.errors %}
                  <div class="text-danger small">
                    {{ form.platform.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.tags.id_for_label }}">Tags</label>
                {{ form.tags }}
                {% if form.tags.errors %}
                  <div class="text-danger small">
                    {{ form.tags.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Comma-separated tags (e.g., ransomware, "string deobfuscation")</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.tools.id_for_label }}">Tools</label>
                {{ form.tools }}
                {% if form.tools.errors %}
                  <div class="text-danger small">
                    {{ form.tools.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Comma-separated tools (e.g., ghidra, x64dbg)</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label>Sample Image (Optional)</label>
                <input type="hidden" id="selected_image" name="image_id" value="">
                <div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" data-toggle="modal" data-target="#imageGalleryModal">
                    <i class="fas fa-images"></i> Select Image
                  </button>
                  <div id="selected_image_preview" class="mt-2" style="display: none;">
                    <img id="preview_img" src="" alt="Selected" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearImageSelection()">
                      <i class="fas fa-times"></i> Remove
                    </button>
                  </div>
                </div>
                <small class="form-text text-muted">Choose an image from gallery</small>
              </div>

              {% if not is_edit %}
              <hr class="my-4">
              <h5 class="mb-3">Reference Solution{% if not user.is_staff %} <span class="text-danger">*</span>{% else %} (Optional){% endif %}</h5>
              
              <div class="form-group">
                <label for="{{ form.reference_solution_title.id_for_label }}">Solution Title{% if not user.is_staff %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.reference_solution_title }}
                {% if form.reference_solution_title.errors %}
                  <div class="text-danger small">
                    {{ form.reference_solution_title.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.reference_solution_type.id_for_label }}">Solution Type{% if not user.is_staff %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.reference_solution_type }}
                {% if form.reference_solution_type.errors %}
                  <div class="text-danger small">
                    {{ form.reference_solution_type.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group" id="reference-url-field">
                <label for="{{ form.reference_solution_url.id_for_label }}">Solution URL{% if not user.is_staff %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.reference_solution_url }}
                {% if form.reference_solution_url.errors %}
                  <div class="text-danger small">
                    {{ form.reference_solution_url.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Provide a link to your writeup, video, or paper</small>
                {% endif %}
              </div>

              <div class="form-group" id="reference-content-field" style="display: none;">
                <label for="reference_solution_content">Solution Content</label>
                <div class="alert alert-info">
                  <i class="fas fa-external-link-alt"></i>
                  <strong>Use Full Editor:</strong> 
                  <a href="{% url 'markdown_editor' %}" target="_blank" class="alert-link" id="openMarkdownEditorLink">Open Markdown Editor</a> to write your on-site solution, you can either copy and paste it back or press "Use in Submit Form".
                </div>
                <textarea id="reference_solution_content" name="reference_solution_content" class="form-control" rows="10" placeholder="Paste your markdown content here..."></textarea>
                <small class="form-text text-muted">Markdown content for on-site solutions.</small>
              </div>
              
              <div class="form-group">
                <label for="{{ form.hide_weeks.id_for_label }}">{{ form.hide_weeks.label }}</label>
                {{ form.hide_weeks }}
                {% if form.hide_weeks.errors %}
                  <div class="text-danger small">
                    {{ form.hide_weeks.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">{{ form.hide_weeks.help_text }}</small>
                {% endif %}
              </div>
              {% endif %}

              {% if form.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form.non_field_errors }}
                </div>
              {% endif %}

              <div class="form-group mb-0">
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-save"></i> {% if is_edit %}Update{% else %}Submit{% endif %}
                </button>
                <a href="{% if is_edit %}{% url 'sample_detail' sha256=task.sha256 task_id=task.id %}{% else %}{% url 'sample_list' %}{% endif %}" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
                {% if is_edit %}
                  <button type="button" class="btn btn-outline-danger float-right" onclick="confirmDelete()">
                    <i class="fas fa-trash-alt"></i> Delete Task
                  </button>
                {% endif %}
              </div>
            </form>
            
            {% if is_edit %}
            <!-- Hidden delete form -->
            <form id="deleteForm" method="post" action="{% url 'delete_task' sha256=task.sha256 task_id=task.id %}" style="display: none;">
              {% csrf_token %}
            </form>
            {% endif %}
          </div>
        </div>

      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Submission Guidelines</h3>
          </div>
          <div class="card-body">
            <p class="small mb-3">The download link must be to malshare or malwarebazaar</p>
            <p class="small mb-0">Choose the appropriate difficulty level, see explanation below</p>
            <p class="small mb-0">You can add analysis tips to the description, it will be in a spoiler</p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Difficulty Levels</h3>
          </div>
          <div class="card-body">
            <h6 class="text-info">Easy</h6>
            <p class="small mb-3">
              Easy samples are not packed or obfuscated or have trivial obfuscation like base64. They should only use favorable execution environments (no Rust or Go). Samples must not be self-modifying. Samples can be inside of installers (NSIS) or basic wrappers (Batch2Exe) which drop the non-packed payload to disk.
            </p>
            
            <h6 class="text-warning">Medium</h6>
            <p class="small mb-3">
              Medium samples are easy to unpack (if packed) and can have some obfuscation or simple anti-reversing techniques. Deobfuscation should not require to change the control flow. But deobfuscation may require to decrypt strings or data. Execution environment can be somewhat unfavorable for current tooling.
            </p>
            
            <h6 class="text-danger">Advanced</h6>
            <p class="small mb-0">
              Advanced samples may require to write custom tooling for unpacking or deobfuscation. They may employ several anti-reversing mechanisms or self-modifying code. They may use control flow obfuscation. They may use unusual execution environments without good RE tooling or use packers which require more work for unpacking than just setting a few breakpoints.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Gallery Modal -->
  <div class="modal fade" id="imageGalleryModal" tabindex="-1" role="dialog" aria-labelledby="imageGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageGalleryModalLabel">Select Sample Image</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if available_images %}
            <div class="row">
              {% for img in available_images %}
                {% cloudinary_url img.image width=300 height=300 crop='fit' as image_url %}
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                  <div class="card image-select-card" data-image-id="{{ img.id }}" data-image-url="{{ image_url }}" style="cursor: pointer;">
                    <img src="{{ image_url }}" class="card-img-top" alt="Sample image" style="width: 100%; height: auto; object-fit: contain; background-color: #f8f9fa;">
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No images available in the database yet.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // Pre-select current image in edit mode
  {% if is_edit and current_image_id %}
  document.addEventListener('DOMContentLoaded', function() {
    const currentImageId = '{{ current_image_id }}';
    if (currentImageId) {
      document.getElementById('selected_image').value = currentImageId;
      
      // Find and show preview of current image
      const imageCard = document.querySelector(`[data-image-id="${currentImageId}"]`);
      if (imageCard) {
        const imgSrc = imageCard.getAttribute('data-image-url');
        document.getElementById('preview_img').src = imgSrc;
        document.getElementById('selected_image_preview').style.display = 'block';
        imageCard.classList.add('selected');
      }
    }
  });
  {% endif %}
  
  // Handle image gallery card clicks
  document.addEventListener('DOMContentLoaded', function() {
    // Add click handlers to image cards
    document.querySelectorAll('.image-select-card').forEach(card => {
      const imageUrl = card.getAttribute('data-image-url');
      const imageId = card.getAttribute('data-image-id');
      
      // Click anywhere on card = select
      card.addEventListener('click', function() {
        selectImage(imageUrl, imageId);
      });
    });
  });
  
  function selectImage(imageUrl, imageId) {
    // Set hidden input value
    document.getElementById('selected_image').value = imageId;
    
    // Update preview
    const previewDiv = document.getElementById('selected_image_preview');
    const previewImg = document.getElementById('preview_img');
    previewImg.src = imageUrl;
    previewDiv.style.display = 'block';
    
    // Highlight selected card
    document.querySelectorAll('.image-select-card').forEach(card => {
      if (card.getAttribute('data-image-id') === imageId) {
        card.classList.add('selected');
      } else {
        card.classList.remove('selected');
      }
    });
    
    // Close modal
    $('#imageGalleryModal').modal('hide');
  }
  
  function clearImageSelection() {
    document.getElementById('selected_image').value = '';
    document.getElementById('selected_image_preview').style.display = 'none';
    document.querySelectorAll('.image-select-card').forEach(card => {
      card.classList.remove('selected');
    });
  }
  
  function confirmDelete() {
    if (confirm('Are you sure you want to delete this analysis task? This action cannot be undone.')) {
      document.getElementById('deleteForm').submit();
    }
  }
  
  // Auto-fill SHA256 from download link
  document.addEventListener('DOMContentLoaded', function() {
    const downloadLinkInput = document.getElementById('id_download_link');
    const sha256Input = document.getElementById('id_sha256');
    
    if (downloadLinkInput && sha256Input) {
      downloadLinkInput.addEventListener('input', function() {
        const url = this.value.trim();
        let sha256 = '';
        
        // Extract SHA256 from MalShare URL
        // Pattern: https://malshare.com/sample.php?action=detail&hash=SHA256
        const malshareMatch = url.match(/[?&]hash=([a-fA-F0-9]{64})/);
        if (malshareMatch) {
          sha256 = malshareMatch[1].toLowerCase();
        }
        
        // Extract SHA256 from MalwareBazaar URL
        // Pattern: https://bazaar.abuse.ch/sample/SHA256/
        const bazaarMatch = url.match(/\/sample\/([a-fA-F0-9]{64})/);
        if (bazaarMatch) {
          sha256 = bazaarMatch[1].toLowerCase();
        }
        
        // Update SHA256 field
        if (sha256) {
          sha256Input.value = sha256;
          sha256Input.classList.remove('is-invalid');
          sha256Input.classList.add('is-valid');
        } else if (url) {
          sha256Input.value = '';
          sha256Input.classList.remove('is-valid');
        }
      });
      
      // Trigger extraction on page load if download link already has value (edit mode)
      if (downloadLinkInput.value) {
        downloadLinkInput.dispatchEvent(new Event('input'));
      }
    }
  });
  
  // Markdown editor integration (load from and save to localStorage)
  document.addEventListener('DOMContentLoaded', function() {
    const titleInput = document.getElementById('id_reference_solution_title');
    const contentTextarea = document.getElementById('reference_solution_content');
    const solutionTypeSelect = document.getElementById('id_reference_solution_type');
    const markdownEditorLink = document.getElementById('openMarkdownEditorLink');
    const sha256Input = document.getElementById('id_sha256');
    const goalInput = document.getElementById('id_goal');
    const descriptionTextarea = document.getElementById('id_description');
    const downloadLinkInput = document.getElementById('id_download_link');
    const selectedImageInput = document.getElementById('selected_image');
    const tagsInput = document.getElementById('id_tags');
    const toolsInput = document.getElementById('id_tools');
    const difficultySelect = document.getElementById('id_difficulty');
    
    // Load saved form data from localStorage if available (on page load)
    const savedTitle = localStorage.getItem('draft_reference_solution_title');
    const savedContent = localStorage.getItem('draft_reference_solution');
    const savedSolutionType = localStorage.getItem('draft_form_solution_type');
    const savedSha256 = localStorage.getItem('draft_form_sha256');
    const savedGoal = localStorage.getItem('draft_form_goal');
    const savedDescription = localStorage.getItem('draft_form_description');
    const savedDownloadLink = localStorage.getItem('draft_form_download_link');
    const savedImageId = localStorage.getItem('draft_form_image_id');
    const savedImageUrl = localStorage.getItem('draft_form_image_url');
    const savedTags = localStorage.getItem('draft_form_tags');
    const savedTools = localStorage.getItem('draft_form_tools');
    const savedDifficulty = localStorage.getItem('draft_form_difficulty');
    
    if (savedTitle && titleInput && !titleInput.value) {
      titleInput.value = savedTitle;
    }
    
    // Restore solution type first (before content)
    if (savedContent && contentTextarea && !contentTextarea.value) {
      // If we have content from markdown editor, always set type to 'onsite'
      if (solutionTypeSelect) {
        solutionTypeSelect.value = 'onsite';
        // Trigger the change event to show/hide fields
        solutionTypeSelect.dispatchEvent(new Event('change'));
      }
      // Then set the content
      contentTextarea.value = savedContent;
    } else if (savedSolutionType && solutionTypeSelect && !solutionTypeSelect.value) {
      solutionTypeSelect.value = savedSolutionType;
      solutionTypeSelect.dispatchEvent(new Event('change'));
    }
    
    // Restore other form fields
    if (savedSha256 && sha256Input && !sha256Input.value) {
      sha256Input.value = savedSha256;
    }
    
    if (savedGoal && goalInput && !goalInput.value) {
      goalInput.value = savedGoal;
    }
    
    if (savedDescription && descriptionTextarea && !descriptionTextarea.value) {
      descriptionTextarea.value = savedDescription;
    }
    
    if (savedDownloadLink && downloadLinkInput && !downloadLinkInput.value) {
      downloadLinkInput.value = savedDownloadLink;
    }
    
    if (savedTags && tagsInput && !tagsInput.value) {
      tagsInput.value = savedTags;
    }
    
    if (savedTools && toolsInput && !toolsInput.value) {
      toolsInput.value = savedTools;
    }
    
    if (savedDifficulty && difficultySelect) {
      // Always restore saved difficulty (select fields may have default values)
      difficultySelect.value = savedDifficulty;
    }
    
    if (savedImageId && selectedImageInput && !selectedImageInput.value) {
      selectedImageInput.value = savedImageId;
      // Restore image preview
      if (savedImageUrl) {
        const previewImg = document.getElementById('preview_img');
        const previewDiv = document.getElementById('selected_image_preview');
        if (previewImg && previewDiv) {
          previewImg.src = savedImageUrl;
          previewDiv.style.display = 'block';
        }
      }
    }
    
    // Transfer data to markdown editor when link is clicked
    if (markdownEditorLink) {
      markdownEditorLink.addEventListener('click', function(e) {
        // Save all form values to localStorage
        if (titleInput) {
          localStorage.setItem('draft_reference_solution_title', titleInput.value);
        }
        if (contentTextarea) {
          localStorage.setItem('draft_reference_solution', contentTextarea.value);
        }
        if (solutionTypeSelect) {
          localStorage.setItem('draft_form_solution_type', solutionTypeSelect.value);
        }
        if (sha256Input) {
          localStorage.setItem('draft_form_sha256', sha256Input.value);
        }
        if (goalInput) {
          localStorage.setItem('draft_form_goal', goalInput.value);
        }
        if (descriptionTextarea) {
          localStorage.setItem('draft_form_description', descriptionTextarea.value);
        }
        if (downloadLinkInput) {
          localStorage.setItem('draft_form_download_link', downloadLinkInput.value);
        }
        if (tagsInput) {
          localStorage.setItem('draft_form_tags', tagsInput.value);
        }
        if (toolsInput) {
          localStorage.setItem('draft_form_tools', toolsInput.value);
        }
        if (difficultySelect) {
          localStorage.setItem('draft_form_difficulty', difficultySelect.value);
        }
        if (selectedImageInput && selectedImageInput.value) {
          localStorage.setItem('draft_form_image_id', selectedImageInput.value);
          const previewImg = document.getElementById('preview_img');
          if (previewImg && previewImg.src) {
            localStorage.setItem('draft_form_image_url', previewImg.src);
          }
        }
      });
    }
  });
  
  // Markdown preview tabs
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.markdown-tab');
    const panes = document.querySelectorAll('.markdown-pane');
    const textarea = document.getElementById('id_description');
    const previewContent = document.querySelector('.markdown-preview-content');
    let previewCache = '';
    
    // Toggle reference solution fields based on type
    const refSolutionTypeSelect = document.getElementById('id_reference_solution_type');
    const refUrlField = document.getElementById('reference-url-field');
    const refContentField = document.getElementById('reference-content-field');
    
    if (refSolutionTypeSelect && refUrlField && refContentField) {
      function toggleRefFields() {
        const selectedType = refSolutionTypeSelect.value;
        if (selectedType === 'onsite') {
          refUrlField.style.display = 'none';
          refContentField.style.display = 'block';
        } else {
          refUrlField.style.display = 'block';
          refContentField.style.display = 'none';
        }
      }
      
      // Initial toggle
      toggleRefFields();
      
      // Listen for changes
      refSolutionTypeSelect.addEventListener('change', toggleRefFields);
    }
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const targetTab = this.getAttribute('data-tab');
        
        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update active pane
        panes.forEach(p => {
          if (p.getAttribute('data-pane') === targetTab) {
            p.classList.add('active');
          } else {
            p.classList.remove('active');
          }
        });
        
        // If switching to preview, render markdown
        if (targetTab === 'preview') {
          const content = textarea.value;
          
          // Only fetch if content changed
          if (content !== previewCache) {
            previewCache = content;
            
            if (!content.trim()) {
              previewContent.innerHTML = '<p class=\"text-muted\">Nothing to preview</p>';
              return;
            }
            
            // Show loading state
            previewContent.innerHTML = '<p class=\"text-muted\"><i class=\"fas fa-spinner fa-spin\"></i> Loading preview...</p>';
            
            // Fetch preview from server
            fetch('{% url "markdown_preview" %}', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
              },
              body: 'content=' + encodeURIComponent(content)
            })
            .then(response => response.json())
            .then(data => {
              previewContent.innerHTML = data.html;
            })
            .catch(error => {
              console.error('Preview error:', error);
              previewContent.innerHTML = '<p class=\"text-danger\">Error loading preview</p>';
            });
          }
        }
      });
    });
  });
  
  // Clear localStorage on successful form submission
  document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[method="post"]');
    if (form) {
      form.addEventListener('submit', function() {
        clearFormDrafts();
      });
    }
  });
  </script>
</section>

{% endblock %}
