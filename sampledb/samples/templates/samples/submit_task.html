{% extends "samples/base.html" %}
{% load cloudinary %}
{% load static %}

{% block title %}{% if is_edit %}Edit{% else %}Submit{% endif %} Sample{% endblock %}

{% block content %}
<div id="form-data-attrs" style="display: none;"
     data-is-edit="{% if is_edit %}true{% else %}false{% endif %}"
     {% if is_edit and current_image_id %}data-current-image-id="{{ current_image_id }}"{% endif %}
     {% if is_edit and task.image and not current_image_id %}data-current-image-url="{% cloudinary_url task.image width=150 height=150 crop='fill' %}"{% endif %}
     data-markdown-preview-url="{% url 'markdown_preview' %}">
</div>

<section class="content-header">
  <div class="container-fluid">
    <h1>{% if is_edit %}Edit{% else %}Submit{% endif %} Sample</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-8">
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Task Details</h3>
          </div>
          <div class="card-body">
            <form method="post" enctype="multipart/form-data" novalidate>
              {% csrf_token %}
              
              {% if form.errors %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Form Validation Errors</h5>
                <p class="mb-2">Please correct the following errors:</p>
                <ul class="mb-0">
                  {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endif %}
                  {% for field in form %}
                    {% if field.errors %}
                      {% for error in field.errors %}
                        <li><strong>{{ field.label }}:</strong> {{ error }}</li>
                      {% endfor %}
                    {% endif %}
                  {% endfor %}
                </ul>
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              {% endif %}
              
              {% if not is_edit and not user.is_staff %}
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> <strong>Reference Solution Required:</strong> You must provide one reference solution (your own writeup, video, or analysis) when submitting a task.
              </div>
              {% endif %}
              
              <div class="form-group">
                <label for="{{ form.sha256.id_for_label }}">SHA256 Hash</label>
                {{ form.sha256 }}
                {% if form.sha256.errors %}
                  <div class="text-danger small">
                    {{ form.sha256.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Auto-filled from download link</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.download_link.id_for_label }}">Download Link</label>
                {{ form.download_link }}
                {% if form.download_link.errors %}
                  <div class="text-danger small">
                    {{ form.download_link.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Provide a malshare or malwarebazaar URL!</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.goal.id_for_label }}">Analysis Goal</label>
                {{ form.goal }}
                {% if form.goal.errors %}
                  <div class="text-danger small">
                    {{ form.goal.errors }}
                  </div>
                {% else %}
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.description.id_for_label }}">Description</label>
                <div class="markdown-tabs">
                  <button type="button" class="markdown-tab active" data-tab="write">Write</button>
                  <button type="button" class="markdown-tab" data-tab="preview">Preview</button>
                </div>
                <div class="markdown-tab-content">
                  <div class="markdown-pane active" data-pane="write">
                    {{ form.description }}
                  </div>
                  <div class="markdown-pane" data-pane="preview">
                    <div class="markdown-preview-content">
                      <p class="text-muted">Nothing to preview</p>
                    </div>
                  </div>
                </div>
                {% if form.description.errors %}
                  <div class="text-danger small">
                    {{ form.description.errors }}
                  </div>
                {% else %}
                <small class="form-text text-muted">This field accepts markdown formatting, feel free to add tips here, the field will be in a spoiler</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.difficulty.id_for_label }}">Difficulty Level</label>
                {{ form.difficulty }}
                {% if form.difficulty.errors %}
                  <div class="text-danger small">
                    {{ form.difficulty.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.tags.id_for_label }}">Tags</label>
                {{ form.tags }}
                {% if form.tags.errors %}
                  <div class="text-danger small">
                    {{ form.tags.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Comma-separated tags (e.g., ransomware, "string deobfuscation")</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.tools.id_for_label }}">Tools</label>
                {{ form.tools }}
                {% if form.tools.errors %}
                  <div class="text-danger small">
                    {{ form.tools.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Comma-separated tools (e.g., ghidra, x64dbg)</small>
                {% endif %}
              </div>

              <div class="form-group">
                <label>Sample Image (Optional)</label>
                
                <!-- Image Preview Area (stays visible) -->
                <div id="image_preview_area" style="display: none;">
                  <div id="upload_image_preview" class="mt-2" style="display: none;">
                    <img id="upload_preview_img" src="" alt="Preview" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearUploadPreview()">
                      <i class="fas fa-times"></i> Remove
                    </button>
                  </div>
                  <div id="selected_image_preview" class="mt-2" style="display: none;">
                    <img id="preview_img" src="" alt="Selected" class="img-thumbnail" style="max-width: 150px; max-height: 150px;">
                    <button type="button" class="btn btn-sm btn-link text-danger" onclick="clearImageSelection()">
                      <i class="fas fa-times"></i> Remove
                    </button>
                  </div>
                </div>
                
                <!-- Upload option -->
                <div class="image-upload-section" id="upload-section">
                  <label class="d-block mb-1"><i class="fas fa-upload"></i> <strong>Upload Your Own</strong></label>
                  {{ form.image_upload }}
                  {% if form.image_upload.errors %}
                    <div class="text-danger small mt-1">
                      {{ form.image_upload.errors }}
                    </div>
                  {% else %}
                    <small class="form-text text-muted">
                      <i class="fas fa-info-circle"></i> Size: 125x125 to 1024x1024 pixels, 1:1 aspect ratio (square). Non-square images will be center-cropped.
                    </small>
                  {% endif %}
                </div>
                
                <!-- Gallery option -->
                <div class="image-gallery-section mt-3 pt-3" id="gallery-section" style="border-top: 1px dashed var(--form-border);">
                  <label class="d-block mb-2"><i class="fas fa-images"></i> <strong>Or Choose from Gallery</strong></label>
                  <input type="hidden" id="selected_image" name="image_id" value="">
                  <input type="hidden" id="clear_image_flag" name="clear_image" value="">
                  <button type="button" class="btn btn-sm btn-secondary" data-toggle="modal" data-target="#imageGalleryModal">
                    <i class="fas fa-image"></i> Browse Gallery
                  </button>
                </div>
              </div>

              {% if not is_edit %}
              <hr class="my-4">
              <h5 class="mb-3">Reference Solution{% if not user.is_staff %} <span class="text-danger">*</span>{% else %} (Optional){% endif %}</h5>
              
              <div class="form-group">
                <label for="{{ form.reference_solution_title.id_for_label }}">Solution Title{% if not user.is_staff %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.reference_solution_title }}
                {% if form.reference_solution_title.errors %}
                  <div class="text-danger small">
                    {{ form.reference_solution_title.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group">
                <label for="{{ form.reference_solution_type.id_for_label }}">Solution Type{% if not user.is_staff %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.reference_solution_type }}
                {% if form.reference_solution_type.errors %}
                  <div class="text-danger small">
                    {{ form.reference_solution_type.errors }}
                  </div>
                {% endif %}
              </div>

              <div class="form-group" id="reference-url-field">
                <label for="{{ form.reference_solution_url.id_for_label }}">Solution URL{% if not user.is_staff %} <span class="text-danger">*</span>{% endif %}</label>
                {{ form.reference_solution_url }}
                {% if form.reference_solution_url.errors %}
                  <div class="text-danger small">
                    {{ form.reference_solution_url.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">Provide a link to your writeup, video, or paper</small>
                {% endif %}
              </div>

              <div class="form-group" id="reference-content-field" style="display: none;">
                <label for="reference_solution_content">Solution Content</label>
                <div class="alert alert-info">
                  <i class="fas fa-external-link-alt"></i>
                  <strong>Use Full Editor:</strong> 
                  <a href="{% url 'markdown_editor' %}" target="_blank" class="alert-link" id="openMarkdownEditorLink">Open Markdown Editor</a> to write your on-site solution, you can either copy and paste it back or press "Use in Submit Form".
                </div>
                <textarea id="reference_solution_content" name="reference_solution_content" class="form-control" rows="10" placeholder="Paste your markdown content here..."></textarea>
                <small class="form-text text-muted">Markdown content for on-site solutions.</small>
              </div>
              
              <div class="form-group">
                <label for="{{ form.hide_weeks.id_for_label }}">{{ form.hide_weeks.label }}</label>
                {{ form.hide_weeks }}
                {% if form.hide_weeks.errors %}
                  <div class="text-danger small">
                    {{ form.hide_weeks.errors }}
                  </div>
                {% else %}
                  <small class="form-text text-muted">{{ form.hide_weeks.help_text }}</small>
                {% endif %}
              </div>
              {% endif %}

              {% if form.non_field_errors %}
                <div class="alert alert-danger">
                  {{ form.non_field_errors }}
                </div>
              {% endif %}

              <div class="form-group mb-0">
                <button type="submit" class="btn btn-danger">
                  <i class="fas fa-save"></i> {% if is_edit %}Update{% else %}Submit{% endif %}
                </button>
                <a href="{% if is_edit %}{% url 'sample_detail' sha256=task.sha256 task_id=task.id %}{% else %}{% url 'sample_list' %}{% endif %}" class="btn btn-secondary">
                  <i class="fas fa-times"></i> Cancel
                </a>
                {% if is_edit %}
                  <button type="button" class="btn btn-outline-danger float-right" onclick="confirmDelete()">
                    <i class="fas fa-trash-alt"></i> Delete Task
                  </button>
                {% endif %}
              </div>
            </form>
            
            {% if is_edit %}
            <!-- Hidden delete form -->
            <form id="deleteForm" method="post" action="{% url 'delete_task' sha256=task.sha256 task_id=task.id %}" style="display: none;">
              {% csrf_token %}
            </form>
            {% endif %}
          </div>
        </div>

      </div>
      
      <div class="col-md-4">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Submission Guidelines</h3>
          </div>
          <div class="card-body">
            <p class="small mb-3">The download link must be to malshare or malwarebazaar</p>
            <p class="small mb-0">Choose the appropriate difficulty level, see explanation below</p>
            <p class="small mb-0">You can add analysis tips to the description, it will be in a spoiler</p>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Difficulty Levels</h3>
          </div>
          <div class="card-body">
            <h6 class="text-info">Easy</h6>
            <p class="small mb-3">
              Easy samples are not packed or obfuscated or have trivial obfuscation like base64. They should only use favorable execution environments (no Rust or Go). Samples must not be self-modifying. Samples can be inside of installers (NSIS) or basic wrappers (Batch2Exe) which drop the non-packed payload to disk.
            </p>
            
            <h6 class="text-warning">Medium</h6>
            <p class="small mb-3">
              Medium samples are easy to unpack (if packed) and can have some obfuscation or simple anti-reversing techniques. Deobfuscation should not require to change the control flow. But deobfuscation may require to decrypt strings or data. Execution environment can be somewhat unfavorable for current tooling.
            </p>
            
            <h6 class="text-danger">Advanced</h6>
            <p class="small mb-0">
              Advanced samples may require to write custom tooling for unpacking or deobfuscation. They may employ several anti-reversing mechanisms or self-modifying code. They may use control flow obfuscation. They may use unusual execution environments without good RE tooling or use packers which require more work for unpacking than just setting a few breakpoints.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Gallery Modal -->
  <div class="modal fade" id="imageGalleryModal" tabindex="-1" role="dialog" aria-labelledby="imageGalleryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageGalleryModalLabel">Select Sample Image</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          {% if available_images %}
            <div class="row">
              {% for img in available_images %}
                {% cloudinary_url img.image width=300 height=300 crop='fit' as image_url %}
                <div class="col-md-3 col-sm-4 col-6 mb-3">
                  <div class="card image-select-card" data-image-id="{{ img.id }}" data-image-url="{{ image_url }}" style="cursor: pointer;">
                    <img src="{{ image_url }}" class="card-img-top" alt="Sample image" style="width: 100%; height: auto; object-fit: contain; background-color: #f8f9fa;">
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">No images available in the database yet.</p>
          {% endif %}
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="{% static 'js/submit-task-form.js' %}"></script>
</section>

{% endblock %}
