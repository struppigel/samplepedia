{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Samplepedia{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 4 CSS (REQUIRED) -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">

  <!-- Font Awesome (for icons) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Google Fonts - Inter for modern look similar to malwareanalysis-for-hedgehogs -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">

  <!-- AdminLTE v3 CSS (REQUIRED) -->
  <link rel="stylesheet" href="{% static 'adminlte/css/adminlte.min.css' %}">
  <style>
  /* Custom theme to look like malwareanalysis-for-hedgehogs */
  :root {
    --primary-red: #e63946;
    --dark-bg: #1e1e1e;
    --darker-bg: #141414;
    --card-bg: #2a2a2a;
    --text-primary: #ffffff;
    --text-secondary: #b0b0b0;
    --accent-red: #ff4757;
  }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  }
  
  /* Dark mode styles */
  .dark-mode {
    background-color: var(--darker-bg) !important;
    color: var(--text-primary);
  }
  
  .dark-mode .navbar-dark {
    background-color: var(--dark-bg) !important;
    border-bottom: 1px solid rgba(230, 57, 70, 0.3);
  }
  
  .dark-mode .content-wrapper {
    background-color: var(--darker-bg) !important;
  }
  
  .dark-mode .card {
    background-color: var(--card-bg) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    border-radius: 8px;
  }
  
  .dark-mode .card-header {
    background-color: rgba(0, 0, 0, 0.2) !important;
    border-bottom: 1px solid rgba(230, 57, 70, 0.3) !important;
  }
  
  /* Dark mode table styling */
  .dark-mode .table {
    color: var(--text-primary) !important;
    background-color: transparent !important;
  }
  
  .dark-mode .table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(255, 255, 255, 0.03) !important;
  }
  
  .dark-mode .table-hover tbody tr:hover {
    background-color: rgba(230, 57, 70, 0.1) !important;
  }
  
  .dark-mode .table td, .dark-mode .table th {
    border-color: rgba(255, 255, 255, 0.08) !important;
  }
  
  /* Dark mode form inputs */
  .dark-mode .form-control {
    background-color: rgba(255, 255, 255, 0.05) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: var(--text-primary) !important;
  }
  
  .dark-mode .form-control:focus {
    background-color: rgba(255, 255, 255, 0.08) !important;
    border-color: var(--primary-red) !important;
    box-shadow: 0 0 0 0.2rem rgba(230, 57, 70, 0.25) !important;
    color: var(--text-primary) !important;
  }
  
  /* Fix for autofill and active input states */
  .dark-mode input.form-control:-webkit-autofill,
  .dark-mode input.form-control:-webkit-autofill:hover,
  .dark-mode input.form-control:-webkit-autofill:focus,
  .dark-mode input.form-control:-webkit-autofill:active {
    -webkit-text-fill-color: var(--text-primary) !important;
    -webkit-box-shadow: 0 0 0 30px rgba(255, 255, 255, 0.08) inset !important;
  }
  
  /* Ensure placeholder text is visible */
  .dark-mode .form-control::placeholder {
    color: var(--text-secondary) !important;
    opacity: 0.6 !important;
  }
  
  /* Dark mode select dropdowns - fix white text on white background */
  .dark-mode select.form-control option {
    background-color: var(--card-bg) !important;
    color: var(--text-primary) !important;
  }
  
  /* Dark mode list groups */
  .dark-mode .list-group-item {
    background-color: var(--card-bg) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: var(--text-primary) !important;
  }
  
  .dark-mode .list-group-item-action:hover {
    background-color: rgba(230, 57, 70, 0.1) !important;
    color: var(--text-primary) !important;
  }
  
  .dark-mode .list-group-item h5 {
    color: var(--text-primary) !important;
  }
  
  /* Dark mode pagination */
  .dark-mode .pagination .page-link {
    background-color: var(--card-bg) !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
    color: var(--text-primary) !important;
  }
  
  .dark-mode .pagination .page-link:hover {
    background-color: rgba(230, 57, 70, 0.2) !important;
    color: var(--primary-red) !important;
  }
  
  .dark-mode .pagination .page-item.active .page-link {
    background-color: var(--primary-red) !important;
    border-color: var(--primary-red) !important;
  }
  
  /* Light mode - default Bootstrap/AdminLTE styling */
  .card {
    border-radius: 8px;
  }
  
  /* Reduce card header padding for both themes */
  .card-header {
    padding: 0.5rem 0.75rem !important;
  }
  
  .card-title {
    margin-bottom: 0 !important;
  }
  
  /* Red accent for links and buttons (both themes) */
  a {
    color: var(--primary-red);
  }
  
  a:hover {
    color: var(--accent-red);
  }
  
  /* Keep text-muted links gray but red on hover */
  a.text-muted {
    color: #6c757d !important;
  }
  
  a.text-muted:hover {
    color: var(--accent-red) !important;
  }
  
  .btn-primary {
    background-color: var(--primary-red) !important;
    border-color: var(--primary-red) !important;
  }
  
  .btn-primary:hover {
    background-color: var(--accent-red) !important;
    border-color: var(--accent-red) !important;
  }

  .btn-back {
    color: var(--primary-red);
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    text-decoration: none;
  }

  .btn-back:hover {
    color: #007bff;
  }
  
  .navbar-brand {
    font-weight: 600;
    letter-spacing: -0.5px;
  }
  
  /* Badges with red accent (both themes) */
  .badge-success {
    background-color: var(--primary-red) !important;
  }
  
  .badge-warning {
    background-color: #ffa726 !important;
  }
  
  .badge-danger {
    background-color: #ef5350 !important;
  }
  
  .badge-dark {
    background-color: #111111 !important;
  }
  
  .badge-info {
    background-color: #17a2b8 !important;
  }
  
  /* Badge hover effects */
  a.badge {
    transition: filter 0.15s ease;
  }
  
  a.badge:hover {
    filter: brightness(1.2);
    text-decoration: none;
  }
  
  /* Align favorite hearts and counts */
  .favorite-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  .favorite-count {
    display: inline-block;
    min-width: 1.5rem;
    text-align: left;
  }
  
  /* Tag colors - generates consistent color per tag */
  .badge-tag {
    color: white !important;
    text-decoration: none;
  }
  
  /* Alert info styling to match theme */
  .alert-info {
    background-color: rgba(57, 69, 230, 0.1) !important;
    border-color: rgba(57, 63, 230, 0.3) !important;
    color: #333 !important;
  }
  
  .dark-mode .alert-info {
    background-color: rgba(57, 92, 230, 0.437) !important;
    border-color: rgba(57, 69, 230, 0.4) !important;
    color: var(--text-primary) !important;
  }
  
  /* Alert link styling for both themes */
  .alert-info .alert-link {
    color: var(--primary-red) !important;
    text-decoration: underline;
    font-weight: 600;
  }
  
  .alert-info .alert-link:hover {
    color: var(--primary-blue) !important;
    text-decoration: underline;
  }
  
  .dark-mode .alert-info .alert-link {
    color: #ffffff !important;
  }
  
  .dark-mode .alert-info .alert-link:hover {
    color: #000000 !important;
  }
  
  /* Spoiler styling (both themes) */
  .spoiler {
    display: inline-block;
    position: relative;
    border-radius: 4px;
    padding: 2px 6px;
    background: rgba(230, 57, 70, 0.1);
    cursor: pointer;
    border: 1px solid rgba(230, 57, 70, 0.3);
  }
  
  .spoiler > .spoiler-text {
    color: transparent;
    user-select: none;
  }
  
  .spoiler::after {
    content: "Spoiler, click to reveal";
    position: absolute;
    inset: 0;
    padding: 2px 6px;
    color: var(--primary-red);
    background: rgba(0, 0, 0, 0.6);
    border-radius: 4px;
    display: flex;
    align-items: center;
    font-weight: 500;
  }
  
  .spoiler.revealed > .spoiler-text {
    color: inherit;
    user-select: text;
  }
  
  .spoiler.revealed::after {
    display: none;
  }
  
  /* Light mode spoiler improvements */
  body:not(.dark-mode) .spoiler {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
  }
  
  body:not(.dark-mode) .spoiler::after {
    background: #6c757d;
    color: white;
  }

  /* Footer styling */
  .main-footer {
    border-top: 1px solid rgba(230, 57, 70, 0.3);
    background-color: #343a40;
  }
  
  .dark-mode .main-footer {
    border-top: 1px solid rgba(230, 57, 70, 0.3);
    background-color: var(--dark-bg);
  }
  
  .main-footer a {
    transition: color 0.2s ease;
  }
  
  .main-footer .text-muted {
    color: rgba(255, 255, 255, 0.85) !important;
  }
  
  .main-footer .text-muted:hover {
    color: var(--accent-red) !important;
  }

  /* Headings */
  h1, h2, h3, h4, h5, h6 {
    font-weight: 600;
  }
  
  /* Light mode form focus */
  .form-control:focus {
    border-color: var(--primary-red) !important;
    box-shadow: 0 0 0 0.2rem rgba(230, 57, 70, 0.25) !important;
  }
</style>

  
</head>

<body class="hold-transition layout-top-nav">

<!-- Apply dark mode immediately before page renders -->
<script>
  (function() {
    const key = "adminlte-dark";
    if (localStorage.getItem(key) === "on") {
      document.body.classList.add("dark-mode");
    }
  })();
</script>

<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-dark">
    <div class="container-fluid">
      <a href="/" class="navbar-brand">
        <img src="{% static 'myhegebatlogo_white.png' %}" alt="Logo" style="height: 30px; margin-right: 10px;">
        <span class="font-weight-bold">Samplepedia</span>
      </a>

      <ul class="navbar-nav ml-auto">
        <li class="nav-item">
          <a href="/" class="nav-link" title="Browse Samples">
            <i class="fas fa-list"></i> Browse
          </a>
        </li>
        <li class="nav-item">
          <a href="{% url 'course_list' %}" class="nav-link" title="Courses">
            <i class="fas fa-graduation-cap"></i> Courses
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link" id="darkToggle" title="Toggle Dark Mode">
            <i class="fas fa-moon" id="darkIcon"></i>
            <i class="fas fa-sun" id="lightIcon" style="display: none;"></i>
            <span id="darkModeText" class="ml-1">Dark</span>
          </a>
        </li>
        {% if user.is_authenticated %}
          <li class="nav-item">
            <span class="nav-link text-muted">
              <i class="fas fa-user"></i> {{ user.username }}
            </span>
          </li>
          <li class="nav-item">
            <form method="post" action="{% url 'logout' %}" style="margin: 0;">
              {% csrf_token %}
              <button type="submit" class="nav-link btn btn-link" style="border: none; background: none; cursor: pointer;" title="Logout">
                <i class="fas fa-sign-out-alt"></i> Logout
              </button>
            </form>
          </li>
        {% else %}
          <li class="nav-item">
            <a href="{% url 'login' %}" class="nav-link" title="Login">
              <i class="fas fa-sign-in-alt"></i> Login
            </a>
          </li>
        {% endif %}
        {% if user.is_staff %}
          <li class="nav-item">
            <a href="/admin/" class="nav-link">Admin</a>
          </li>
        {% endif %}
      </ul>
    </div>
  </nav>

  <!-- Content -->
  <div class="content-wrapper">
    {% block content %}{% endblock %}
  </div>

</div>

<!-- JS (LOAD ONCE, IN THIS ORDER) -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="{% static 'adminlte/js/adminlte.min.js' %}"></script>

<!-- Dark mode toggle -->
<script>
  const key = "adminlte-dark";
  const body = document.body;
  const toggle = document.getElementById("darkToggle");
  const darkIcon = document.getElementById("darkIcon");
  const lightIcon = document.getElementById("lightIcon");
  const darkModeText = document.getElementById("darkModeText");

  function updateIcon() {
    if (body.classList.contains("dark-mode")) {
      darkIcon.style.display = "none";
      lightIcon.style.display = "inline-block";
      if (darkModeText) darkModeText.textContent = "Light";
    } else {
      darkIcon.style.display = "inline-block";
      lightIcon.style.display = "none";
      if (darkModeText) darkModeText.textContent = "Dark";
    }
  }

  // Update icon on page load
  updateIcon();

  if (toggle) {
    toggle.onclick = function (e) {
      e.preventDefault();
      body.classList.toggle("dark-mode");
      localStorage.setItem(
        key,
        body.classList.contains("dark-mode") ? "on" : "off"
      );
      updateIcon();
    };
  }
</script>

<script>
  document.addEventListener("click", function (e) {
    const el = e.target.closest(".spoiler");
    if (el) el.classList.toggle("revealed");
  });
</script>

<!-- Tag color generator -->
<script>
  // Generate consistent color for each tag based on tag name
  function hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      hash = ((hash << 5) - hash) + str.charCodeAt(i);
      hash = hash & hash;
    }
    return Math.abs(hash);
  }
  
  document.querySelectorAll('.badge-tag').forEach(badge => {
    const tagName = badge.textContent.trim();
    const hue = hashString(tagName) % 360;
    const saturation = 65;
    const lightness = 50;
    badge.style.backgroundColor = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
  });
  
  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  // Consolidated favorite button functionality (works for both list and detail views)
  document.querySelectorAll('.favorite-btn').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const sha256 = this.dataset.sha256;
      const taskId = this.dataset.taskId;
      
      // Send AJAX request to toggle favorite
      fetch(`/sample/${sha256}/${taskId}/like/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(data => {
        // Check if login is required
        if (data.error && data.redirect) {
          window.location.href = data.redirect;
          return;
        }
        
        // Update button appearance
        const span = this.querySelector('span');
        const icon = this.querySelector('i');
        const countSpan = this.querySelector('.favorite-count');
        
        if (data.liked) {
          span.classList.remove('text-muted');
          span.classList.add('text-danger');
          icon.classList.remove('far');
          icon.classList.add('fas');
        } else {
          span.classList.remove('text-danger');
          span.classList.add('text-muted');
          icon.classList.remove('fas');
          icon.classList.add('far');
        }
        
        // Update count and dataset
        countSpan.textContent = data.like_count;
        this.dataset.liked = data.liked;
        span.title = `${data.like_count} favorite${data.like_count !== 1 ? 's' : ''}`;
      })
      .catch(error => console.error('Error:', error));
    });
  });
</script>

<!-- Footer -->
<footer class="main-footer text-center py-3" style="font-size: 0.875rem;">
  <div class="container">
    <a href="/impressum/" class="text-muted mx-2">Impressum</a>
    <span class="text-muted">|</span>
    <a href="/privacy/" class="text-muted mx-2">Privacy Policy</a>
    <span class="text-muted">|</span>
    <a href="https://discord.gg/xEkHFNKX" class="text-muted mx-2" target="_blank" rel="noopener">
      <i class="fab fa-discord"></i> Discord
    </a>
  </div>
</footer>

</body>
</html>
