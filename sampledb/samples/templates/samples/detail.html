{% extends "samples/base.html" %}

{% block title %}{{ sample.sha256 }}{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Sample</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <!-- Main Layout: Left (Metadata + Analysis) | Right (Image + Video) -->
    <div class="row">
      <!-- LEFT COLUMN: Metadata and Analysis -->
      <div class="{% if sample.image or sample.youtube_id %}col-md-8{% else %}col-md-12{% endif %}">
        
        <!-- Metadata Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Metadata</h3>
            <div class="card-tools">
              <button class="btn btn-link p-0 favorite-btn" 
                      data-sha256="{{ sample.sha256 }}"
                      data-liked="{{ user_has_liked|yesno:'true,false' }}"
                      style="border: none; background: none; cursor: pointer;">
                {% if user_has_liked %}
                  <span class="text-danger" title="{{ sample.favorite_count }} favorite{{ sample.favorite_count|pluralize }}">
                    <i class="fas fa-heart"></i> <span class="favorite-count">{{ sample.favorite_count }}</span>
                  </span>
                {% else %}
                  <span class="text-muted" title="{{ sample.favorite_count }} favorite{{ sample.favorite_count|pluralize }}">
                    <i class="far fa-heart"></i> <span class="favorite-count">{{ sample.favorite_count }}</span>
                  </span>
                {% endif %}
              </button>
            </div>
          </div>
          <div class="card-body">
            <dl class="row mb-0">
              <dt class="col-sm-3">SHA256</dt>
              <dd class="col-sm-9">
                <code id="sha256Text">{{ sample.sha256 }}</code>
                <button class="btn btn-sm btn-link text-muted ml-2" id="copySha256" title="Copy SHA256" style="text-decoration: none; box-shadow: none !important; outline: none !important;">
                  <i class="fas fa-copy"></i>
                </button>
              </dd>

              <dt class="col-sm-3">Difficulty</dt>
              <dd class="col-sm-9">
                <a href="/?difficulty={{ sample.difficulty }}"
                   class="badge
                   {% if sample.difficulty == 'easy' %}badge-info
                   {% elif sample.difficulty == 'medium' %}badge-warning
                   {% elif sample.difficulty == 'advanced' %}badge-danger
                   {% else %}badge-dark{% endif %}">
                  {{ sample.difficulty }}
                </a>
              </dd>

              <dt class="col-sm-3">Tags</dt>
              <dd class="col-sm-9">
                {% for tag in sample.tags.all %}
                  <a href="/?tag={{ tag.name|urlencode }}" class="badge badge-tag">
                    {{ tag.name }}
                  </a>
                {% empty %}
                  <span class="text-muted">—</span>
                {% endfor %}
              </dd>
            </dl>
          </div>
        </div>

        <!-- Analysis Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Analysis</h3>
          </div>
          <div class="card-body">
            {% if sample.goal %}
              <h6>Goal</h6>
              <p>{{ sample.goal|linebreaks }}</p>
            {% endif %}

            {% if sample.description %}
              <h6>Description</h6>
              <div class="spoiler">
                <div class="spoiler-text">{{ sample.description|linebreaks }}</div>
              </div>
            {% endif %}

            {% if sample.tools %}
              <h6>Tools</h6>
              <p>{{ sample.tools|linebreaks }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Image and Video -->
      {% if sample.image or sample.youtube_id %}
      <div class="col-md-4">
        
        <!-- Image Card -->
        {% if sample.image %}
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Image</h3>
          </div>
          <div class="card-body">
            <img src="{{ sample.image.url }}" alt="Sample image" class="img-fluid rounded">
          </div>
        </div>
        {% endif %}

        <!-- Video Card -->
        {% if sample.youtube_id %}
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Video</h3>
          </div>
          <div class="card-body">
            <div class="embed-responsive embed-responsive-16by9"
                 style="max-width: 560px; margin-left: auto; margin-right: auto;">
              <iframe class="embed-responsive-item" width="560" height="315" src="https://www.youtube.com/embed/{{ sample.youtube_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
      {% endif %}
    </div>


    <!-- Download -->
    {% if sample.download_link %}
    <div class="card card-danger">
      <div class="card-body">
        <h5 class="text-danger mb-2">
          <i class="fas fa-exclamation-triangle"></i> Warning: Malware
        </h5>
        <p class="text-muted mb-3">This is a live malware sample. Handle in an isolated environment. Archive is password protected with the password "infected"</p>
        <a href="{{ sample.download_link }}"
           target="_blank"
           class="btn btn-danger">
          <i class="fas fa-download"></i> Download sample
        </a>
      </div>
    </div>
    {% endif %}

    <a href="/" class="btn btn-link mt-2">
      ← Back to list
    </a>

  </div>
</section>

<script>
// Copy SHA256 functionality
document.getElementById('copySha256').addEventListener('click', function() {
  const sha256Text = document.getElementById('sha256Text').textContent;
  navigator.clipboard.writeText(sha256Text).then(() => {
    const icon = this.querySelector('i');
    icon.classList.remove('fa-copy');
    icon.classList.add('fa-check');
    this.blur(); // Remove focus to prevent outline
    
    setTimeout(() => {
      icon.classList.remove('fa-check');
      icon.classList.add('fa-copy');
    }, 2000);
  });
});
</script>

{% endblock %}
