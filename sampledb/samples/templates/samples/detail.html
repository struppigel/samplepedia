{% extends "samples/base.html" %}

{% block title %}{{ sample.sha256 }}{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Sample</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <!-- Main Layout: Left (Metadata + Analysis) | Right (Image + Video) -->
    <div class="row">
      <!-- LEFT COLUMN: Metadata and Analysis -->
      <div class="{% if sample.image or sample.youtube_id %}col-md-8{% else %}col-md-12{% endif %}">
        
        <!-- Metadata Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Metadata</h3>
            <div class="card-tools">
              <button id="likeButton" class="btn btn-sm {% if user_has_liked %}btn-danger{% else %}btn-outline-secondary{% endif %}" 
                      data-sha256="{{ sample.sha256 }}"
                      data-liked="{{ user_has_liked|yesno:'true,false' }}">
                <i class="{% if user_has_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                <span id="likeCount">{{ sample.like_count }}</span>
              </button>
            </div>
          </div>
          <div class="card-body">
            <dl class="row mb-0">
              <dt class="col-sm-3">SHA256</dt>
              <dd class="col-sm-9">
                <code>{{ sample.sha256 }}</code>
              </dd>

              <dt class="col-sm-3">Difficulty</dt>
              <dd class="col-sm-9">
                <a href="/?difficulty={{ sample.difficulty }}"
                   class="badge
                   {% if sample.difficulty == 'easy' %}badge-success
                   {% elif sample.difficulty == 'medium' %}badge-warning
                   {% elif sample.difficulty == 'advanced' %}badge-danger
                   {% else %}badge-dark{% endif %}">
                  {{ sample.difficulty }}
                </a>
              </dd>

              <dt class="col-sm-3">Tags</dt>
              <dd class="col-sm-9">
                {% for tag in sample.tags.all %}
                  <a href="/?tag={{ tag.name|urlencode }}" class="badge badge-tag">
                    {{ tag.name }}
                  </a>
                {% empty %}
                  <span class="text-muted">—</span>
                {% endfor %}
              </dd>
            </dl>
          </div>
        </div>

        <!-- Analysis Card -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Analysis</h3>
          </div>
          <div class="card-body">
            {% if sample.goal %}
              <h6>Goal</h6>
              <p>{{ sample.goal|linebreaks }}</p>
            {% endif %}

            {% if sample.description %}
              <h6>Description</h6>
              <div class="spoiler">
                <div class="spoiler-text">{{ sample.description|linebreaks }}</div>
              </div>
            {% endif %}

            {% if sample.tools %}
              <h6>Tools</h6>
              <p>{{ sample.tools|linebreaks }}</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Image and Video -->
      {% if sample.image or sample.youtube_id %}
      <div class="col-md-4">
        
        <!-- Image Card -->
        {% if sample.image %}
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Image</h3>
          </div>
          <div class="card-body">
            <img src="{{ sample.image.url }}" alt="Sample image" class="img-fluid rounded">
          </div>
        </div>
        {% endif %}

        <!-- Video Card -->
        {% if sample.youtube_id %}
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Video</h3>
          </div>
          <div class="card-body">
            <div class="embed-responsive embed-responsive-16by9"
                 style="max-width: 560px; margin-left: auto; margin-right: auto;">
              <iframe class="embed-responsive-item" width="560" height="315" src="https://www.youtube.com/embed/{{ sample.youtube_id }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
            </div>
          </div>
        </div>
        {% endif %}
        
      </div>
      {% endif %}
    </div>


    <!-- Download -->
    {% if sample.download_link %}
    <div class="card card-danger">
      <div class="card-body">
        <a href="{{ sample.download_link }}"
           target="_blank"
           class="btn btn-danger">
          Download sample
        </a>
      </div>
    </div>
    {% endif %}

    <a href="/" class="btn btn-link mt-2">
      ← Back to list
    </a>

  </div>
</section>

<script>
// Like button functionality
document.getElementById('likeButton').addEventListener('click', function() {
  const button = this;
  const sha256 = button.dataset.sha256;
  const likeCountSpan = document.getElementById('likeCount');
  const icon = button.querySelector('i');
  
  // Send AJAX request to toggle like
  fetch(`/sample/${sha256}/like/`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': getCookie('csrftoken'),
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    // Update button appearance
    if (data.liked) {
      button.classList.remove('btn-outline-secondary');
      button.classList.add('btn-danger');
      icon.classList.remove('far');
      icon.classList.add('fas');
    } else {
      button.classList.remove('btn-danger');
      button.classList.add('btn-outline-secondary');
      icon.classList.remove('fas');
      icon.classList.add('far');
    }
    
    // Update like count
    likeCountSpan.textContent = data.like_count;
    button.dataset.liked = data.liked;
  })
  .catch(error => console.error('Error:', error));
});

// Helper function to get CSRF token from cookies
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
