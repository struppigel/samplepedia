{% extends "samples/base.html" %}

{% load url_helpers %}  
{% load cloudinary %}
{% load user_tags %}
{% block title %}Latest Solutions{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <h1>Solutions Overview</h1>
  </div>
</section>

<section class="content">
  <div class="container-fluid">

    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Solution Search</h3>

        <div class="card-tools">
          <form method="get" class="form-inline">
            <div class="input-group input-group-sm mr-2" style="width: 300px;">
              <input
                type="text"
                name="q"
                class="form-control"
                placeholder="Search title or SHA256"
                value="{{ q }}"
              >
            </div>
            
            <select name="solution_type" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Types</option>
              {% for value, label in solution_types %}
                <option value="{{ value }}" {% if selected_type == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
            
            <select name="difficulty" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Levels</option>
              {% for value, label in difficulties %}
                <option value="{{ value }}" {% if selected_difficulty == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            
            <select name="platform" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Platforms</option>
              {% for value, label in platforms %}
                <option value="{{ value }}" {% if selected_platform == value %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            
            <select name="tag" class="form-control form-control-sm mr-2" style="width: 120px;" onchange="this.form.submit()">
              <option value="">All Tags</option>
              {% for tag in all_tags %}
                <option value="{{ tag.name }}" {% if selected_tag == tag.name %}selected{% endif %}>
                  {{ tag.name }}
                </option>
              {% endfor %}
            </select>
            
            <button type="submit" class="btn btn-default btn-sm mr-2">
              Filter
            </button>
            {% if q or selected_type or selected_tag or selected_difficulty or selected_platform %}
              <a href="{% url 'solution_list' %}" class="btn btn-sm btn-secondary mr-2">Clear</a>
            {% endif %}
          </form>
        </div>
      </div>

      <div class="card-body p-0">
        <table class="table table-striped table-hover text-nowrap table-sm" style="table-layout: fixed;">
          <thead>
            <tr>
              <th style="min-width: 100px;cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='title' minus_field='-title' label='Solution' %}
              </th>
              <th style="width: 100px; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='author' minus_field='-author' label='Author' %}
              </th>
              <th style="cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='sha256' minus_field='-sha256' label='SHA256' %}
              </th>
              <th style="width: 100px; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='difficulty' minus_field='-difficulty' label='Difficulty' %}
              </th>
              <th><span class="text-dark">Tags</span></th>
              <th style="width: 80px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='likes' minus_field='-likes' label='Likes' %}
              </th>
              <th style="width: 120px; text-align: center; cursor: pointer;">
                {% include 'samples/_sortable_column.html' with field='created' minus_field='-created' label='Posted' %}
              </th>
            </tr>
          </thead>
          <tbody>
            {% for solution in page_obj %}
            <tr>
              <!-- Solution Title with Link -->
              <td style="max-width: 400px; min-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                <i class="fas {{ solution.solution_type|solution_icon }} mr-2"></i>
                {% if solution.solution_type == 'onsite' %}
                  <a href="{% url 'view_onsite_solution' solution.analysis_task.sha256 solution.analysis_task.id solution.id %}" title="{{ solution.title }}" class="text-dark">
                    {{ solution.title }}
                  </a>
                {% else %}
                  <a href="{{ solution.url }}" target="_blank" class="text-dark" rel="noopener noreferrer" title="{{ solution.title }}" onclick="return confirm('You are about to visit an external website:\n\n{{ solution.url }}\n\nDo you want to continue?');">
                    {{ solution.title }}
                  </a>
                {% endif %}
                {% if solution.hidden_until and solution.user_can_see_hidden_status %}
                  <span class="badge badge-warning ml-1" title="Hidden until {{ solution.hidden_until|date:'M d, Y H:i' }}">
                    <i class="fas fa-eye-slash"></i> Hidden
                  </span>
                {% endif %}
              </td>

              <!-- Author -->
              <td>
                <a href="{% url 'user_profile' solution.author.username %}" class="text-dark">
                  {{ solution.author.username }}
                </a>
              </td>

              <!-- Related Sample -->
              <td style="max-width: 200px; padding: 0.3rem 0.75rem;">
                <a href="{% url 'sample_detail' solution.analysis_task.sha256 solution.analysis_task.id %}" class="d-flex align-items-center" style="min-width: 0;">
                  <i class="{{ solution.analysis_task.platform|platform_icon }} mr-1" style="flex-shrink: 0; font-size: 1.2rem;"></i>
                  <code style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0;" title="{{ solution.analysis_task.sha256 }}">{{ solution.analysis_task.sha256 }}</code>
                </a>
              </td>

              <!-- Difficulty Badge -->
              <td>
                {% include 'samples/_difficulty_badge.html' with difficulty=solution.analysis_task.difficulty difficulty_display=solution.analysis_task.get_difficulty_display filter_url='/solutions/' %}
              </td>

              <!-- Tags -->
              <td>
                {% include 'samples/_expandable_tag_list.html' with tags=solution.analysis_task.tags.all max_width='200px' filter_url='/solutions/' %}
              </td>

              <!-- Likes -->
              <td style="text-align: center;">
                {% solution_like_button solution user_liked_solution_ids %}
              </td>

              <!-- Created Date -->
              <td style="text-align: center;">
                <span class="text-muted" title="{{ solution.created_at|date:'Y-m-d H:i' }}">
                  {{ solution.created_at|date:"d M Y" }}
                </span>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">
                No solutions found.
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-footer clearfix">
        <span class="float-left text-muted">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        <ul class="pagination pagination-sm m-0 float-right">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="{% url_replace page=page_obj.previous_page_number %}">
              «
            </a>
          </li>
          {% endif %}
          
          {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="{% url_replace page=page_obj.next_page_number %}">
              »
            </a>
          </li>
          {% endif %}
        </ul>
      </div>

    </div>

  </div>
</section>

{% endblock %}
