{% extends "samples/base.html" %}
{% block title %}Markdown Editor{% endblock %}

{% block content %}

<section class="content-header">
  <div class="container-fluid">
    <div class="row mb-2">
      <div class="col-sm-6">
        <h1>Markdown Editor</h1>
      </div>
      <div class="col-sm-6">
        <div class="float-right">
          <button type="button" class="btn btn-secondary" id="clearEditor">
            <i class="fas fa-trash"></i> Clear
          </button>
          <button type="button" class="btn btn-primary" id="copyMarkdown">
            <i class="fas fa-copy"></i> Copy Markdown
          </button>
          <a href="{% url 'submit_task' %}" class="btn btn-danger" id="useInSubmitForm">
            <i class="fas fa-paper-plane"></i> Use in Submit Form
          </a>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        
        {% include "samples/_onsite_editor.html" %}
        
      </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Wait for editor API to be available
  const waitForEditor = setInterval(function() {
    if (window.editorAPI) {
      clearInterval(waitForEditor);
      initPageSpecificFeatures();
    }
  }, 50);
  
  function initPageSpecificFeatures() {
    const textarea = window.editorAPI.getTextarea();
    const titleInput = window.editorAPI.getTitleInput();
    const previewContent = window.editorAPI.getPreviewContent();
    const clearBtn = document.getElementById('clearEditor');
    const copyBtn = document.getElementById('copyMarkdown');
    
    // Restore title from submit form data if available
    const FORM_DATA_KEY = 'submit_task_form_data';
    const savedFormData = localStorage.getItem(FORM_DATA_KEY);
    if (savedFormData && titleInput) {
      try {
        const formData = JSON.parse(savedFormData);
        if (formData.reference_solution_title) {
          titleInput.value = formData.reference_solution_title;
        }
      } catch (e) {
        console.error('Error restoring title:', e);
      }
    }
    
    // Clear editor
    clearBtn.addEventListener('click', function() {
      if (textarea.value && !confirm('Are you sure you want to clear all content?')) {
        return;
      }
      textarea.value = '';
      window.editorAPI.setPreviewCache('');
      window.editorAPI.updateCharCount();
      previewContent.innerHTML = '<p class="text-muted">Nothing to preview</p>';
      localStorage.removeItem(STORAGE_KEY);
    });
    
    // Use in Submit Form - save to localStorage and navigate
    const useInSubmitBtn = document.getElementById('useInSubmitForm');
    useInSubmitBtn.addEventListener('click', function(e) {
      if (!textarea.value.trim()) {
        e.preventDefault();
        alert('Please write some content first!');
        return;
      }
      
      // Save content to localStorage with special key for submit form
      localStorage.setItem('draft_reference_solution', textarea.value);
      
      // Also save/update the title in form data if it was entered
      if (titleInput && titleInput.value) {
        const savedFormData = localStorage.getItem(FORM_DATA_KEY);
        let formData = {};
        if (savedFormData) {
          try {
            formData = JSON.parse(savedFormData);
          } catch (e) {
            formData = {};
          }
        }
        formData.reference_solution_title = titleInput.value;
        localStorage.setItem(FORM_DATA_KEY, JSON.stringify(formData));
      }
      
      // Visual feedback before navigation
      const originalHtml = this.innerHTML;
      this.innerHTML = '<i class="fas fa-check"></i> Saved!';
      this.classList.remove('btn-danger');
      this.classList.add('btn-success');
      
      // Navigate after brief delay
      setTimeout(() => {
        window.location.href = this.getAttribute('href');
      }, 500);
    });
    
    // Copy markdown to clipboard
    copyBtn.addEventListener('click', function() {
      if (!textarea.value) {
        alert('Nothing to copy!');
        return;
      }
      
      textarea.select();
      textarea.setSelectionRange(0, 99999); // For mobile devices
      
      navigator.clipboard.writeText(textarea.value).then(function() {
        // Visual feedback
        const originalHtml = copyBtn.innerHTML;
        copyBtn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        copyBtn.classList.remove('btn-primary');
        copyBtn.classList.add('btn-success');
        
        setTimeout(function() {
          copyBtn.innerHTML = originalHtml;
          copyBtn.classList.remove('btn-success');
          copyBtn.classList.add('btn-primary');
        }, 2000);
      }).catch(function(err) {
        console.error('Copy failed:', err);
        alert('Failed to copy to clipboard');
      });
    });
    
    // Auto-save to localStorage
    const STORAGE_KEY = 'markdown_editor_content';
    const AUTOSAVE_INTERVAL = 5000; // 5 seconds
    
    // Load saved content on page load
    // First check if we have content from submit form, otherwise check auto-saved content
    let contentToRestore = null;
    if (savedFormData) {
      try {
        const formData = JSON.parse(savedFormData);
        if (formData.reference_solution_content) {
          contentToRestore = formData.reference_solution_content;
        }
      } catch (e) {
        console.error('Error parsing form data:', e);
      }
    }
    
    // If no content from form data, check auto-saved content
    if (!contentToRestore) {
      contentToRestore = localStorage.getItem(STORAGE_KEY);
    }
    
    // Restore content if found
    if (contentToRestore) {
      textarea.value = contentToRestore;
      window.editorAPI.updateCharCount();
    }
    
    // Auto-save
    setInterval(function() {
      if (textarea.value) {
        localStorage.setItem(STORAGE_KEY, textarea.value);
      }
    }, AUTOSAVE_INTERVAL);
  }
});
</script>

{% endblock %}
